{% extends "helpdesk/base.html" %}
{% load tz users %}
{% block title %}Dashboard - Helpdesk{% endblock %}

{% block content %}
<div class="fade-in">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">
      üß≠ Dashboard
    </h1>

    <div class="d-flex gap-2">
      {% if perms.auth.view_user %}
        <a href="{% url 'helpdesk:users_list' %}" class="btn btn-outline-primary">
          <i class="bi bi-people me-1"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        </a>
      {% endif %}
      {% if perms.helpdesk.add_ticket %}
        <a href="{% url 'helpdesk:ticket_create' %}" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i>‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
        </a>
      {% endif %}
    </div>
  </div>

  <!-- KPI Row -->
  <div class="row g-3 mb-4">
    <!-- ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô -->
    <div class="col-12 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)</div>
        <div class="kpi-value">{{ my_open_count }}</div>
      </div>
    </div>

    {% if is_it_staff %}
      {# IT ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á "‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô" ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å #}
      <div class="col-12 col-md-3">
        <div class="kpi-card">
          <div class="kpi-label">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô</div>
          <div class="kpi-value">{{ assigned_to_me }}</div>
        </div>
      </div>

      {# By Status ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà 6 ‡∏ä‡πà‡∏≠‡∏á #}
      <div class="col-12 col-md-6">
    {% else %}
      {# ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: By Status ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î #}
      <div class="col-12 col-md-9">
    {% endif %}
        <div class="card card-quiet p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</div>
          </div>

          <div class="mt-2 d-flex flex-wrap gap-2">
            {% for row in by_status %}
              {% with st=row.status|default:"unknown" %}
                <span class="badge badge-status-{{ st|slugify }} px-3 py-2 rounded-pill">
                  {{ row.label|default:st }}: {{ row.c }}
                </span>
              {% endwith %}
            {% empty %}
              <span class="text-muted">No data</span>
            {% endfor %}
          </div>
        </div>
      </div>
  </div>

  {# ===== Filters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÉ‡∏ä‡πâ context ‡∏à‡∏≤‡∏Å views.dashboard ‡πÉ‡∏´‡∏°‡πà) ===== #}
  <form class="card card-quiet p-3 mb-3" method="get">
    <div class="row g-2 align-items-center">

      <div class="col-12 col-md-4">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text"
                 class="form-control"
                 name="q"
                 value="{{ q|default:'' }}"
                 placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...">
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-sliders"></i></span>
          <select name="status" class="form-select">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            {% for key, label in status_choices %}
              <option value="{{ key }}" {% if status == key %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="col-6 col-md-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
          <input type="date"
                 class="form-control"
                 name="date_from"
                 value="{{ date_from|default:'' }}"
                 aria-label="‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
        </div>
      </div>

      <div class="col-6 col-md-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
          <input type="date"
                 class="form-control"
                 name="date_to"
                 value="{{ date_to|default:'' }}"
                 aria-label="‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
        </div>
      </div>

      <div class="col-6 col-md-1">
        <button class="btn btn-outline-secondary w-100" type="submit">
          ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
      </div>

    </div>
  </form>

  <!-- Recent table -->
  <div class="card card-quiet p-3">
    <div class="d-flex align-items-center justify-content-between">
      <div class="fw-bold">
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        {% if q or status or date_from or date_to %}
          <small class="text-muted">(‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</small>
        {% endif %}
      </div>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'helpdesk:ticket_list' %}">
        <i class="bi bi-list-task me-1"></i>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </a>
    </div>

    <div class="table-responsive mt-2">
      <table id="recentTable" class="table align-middle">
        <thead>
          <tr class="text-muted">
            <th scope="col">#</th>
            <th scope="col">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
            <th scope="col">‡∏´‡∏°‡∏ß‡∏î</th>
            <th scope="col">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th scope="col">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</th>
            <th scope="col">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
            <th scope="col">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
          </tr>
        </thead>
        <tbody>
          {% for t in recent %}
            <tr class="table-row-link" role="link" tabindex="0"
                data-href="{% url 'helpdesk:ticket_detail' t.id %}">
              <td>{{ t.id }}</td>
              <td class="fw-semibold">{{ t.title }}</td>
              <td>{% if t.category %}{{ t.category.name }}{% else %}-{% endif %}</td>
              <td>
                {% if t.status %}
                  <span class="badge badge-status-{{ t.status|slugify }}">
                    {{ t.get_status_display|default:t.status }}
                  </span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>{% if t.requester %}{{ t.requester|display_name }}{% else %}-{% endif %}</td>
              <td>{% if t.assignee %}{{ t.assignee|display_name }}{% else %}-{% endif %}</td>
              <td>
                {% if t.updated_at %}{{ t.updated_at|localtime|date:"d-m-Y H:i" }}
                {% elif t.created_at %}{{ t.created_at|localtime|date:"d-m-Y H:i" }}
                {% else %}-{% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7" class="text-center text-muted py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  $.fn.dataTable.ext.errMode = 'none';

  document.addEventListener('DOMContentLoaded', function () {
    if (window.jQuery && $.fn.DataTable) {
      $('#recentTable').DataTable({
        ordering: true,
        order: [[0, 'desc']],   // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á id ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
        paging: true,           // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
        pageLength: 20,         // ‡πÅ‡∏™‡∏î‡∏á 20 ‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
        lengthChange: false,    // ‡∏ã‡πà‡∏≠‡∏ô dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß (‡πÉ‡∏´‡πâ fix ‡∏ó‡∏µ‡πà 20)
        info: true,             // ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á "Showing 1 to 20 of ..."
        searching: false        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏ó‡∏ô search ‡∏Ç‡∏≠‡∏á DataTables
      });
    }
  });

  // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ detail ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß
  document.addEventListener('click', (e) => {
    const tr = e.target.closest('.table-row-link');
    if (!tr) return;
    if (e.target.closest('a,button,input,select,label,.form-check')) return;
    if (tr.dataset.href) window.location = tr.dataset.href;
  });

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    const tr = document.activeElement?.closest?.('.table-row-link');
    if (tr?.dataset.href) window.location = tr.dataset.href;
  });
</script>
{% endblock %}
