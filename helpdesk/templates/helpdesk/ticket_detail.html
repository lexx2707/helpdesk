{% extends "helpdesk/base.html" %}
{% load tz users %}
{% block title %}Ticket #{{ ticket.id }} - Helpdesk{% endblock %}

{% block content %}
<div class="fade-in">

  <!-- Header -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h1 class="h4 mb-0">#{{ ticket.id }} — {{ ticket.title }}</h1>
    {# ไม่แสดงปุ่มแก้ไขมุมขวาบน ตามที่ตกลง #}
  </div>

  <div class="row g-3 mb-3">
    <!-- Left: ticket info + attachments + comments -->
    <div class="col-12 col-lg-9">
      <div class="card card-quiet p-3">

        <div class="mb-2">
          {% if ticket.status %}
            <span class="badge badge-status-{{ ticket.status|slugify }}">
              {{ ticket.get_status_display|default:ticket.status }}
            </span>
          {% else %}
            <span class="badge text-bg-light">-</span>
          {% endif %}

        </div>

        <div class="text-muted small mb-2">
          สร้างโดย
          <strong>
            {% if ticket.requester %}{{ ticket.requester|display_name }}{% else %}-{% endif %}
          </strong>
          {% if ticket.assignee %} • ผู้รับผิดชอบ
            <strong>{{ ticket.assignee|display_name }}</strong>
          {% endif %}
          • หมวด
          <strong>{% if ticket.category %}{{ ticket.category.name }}{% else %}-{% endif %}</strong>
          • สร้างเมื่อ {{ ticket.created_at|localtime|date:"d-m-Y H:i" }}
          • อัปเดต {{ ticket.updated_at|localtime|date:"d-m-Y H:i" }}
        </div>

        {# แสดงเบอร์โทร / Line ID ถ้ามี #}
        <div class="small mb-3">
          <strong>ติดต่อ:</strong>
          {% if ticket.contact %}
            {{ ticket.contact }}
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </div>

        {# คำอธิบายงาน #}
        <div class="mt-2 mb-3">
          {{ ticket.description|default:"(ไม่มีคำอธิบาย)"|linebreaksbr }}
        </div>

        {# รูปแนบ (ถ้ามี) #}
        {% if ticket.images.all %}
          <div class="mt-3">
            <h2 class="h6 mb-2">
              <i class="bi bi-image me-1"></i>รูปภาพประกอบ
            </h2>
            <div class="d-flex flex-wrap gap-2">
              {% for img in ticket.images.all %}
                <a href="{{ img.image.url }}"
                   target="_blank"
                   class="border rounded overflow-hidden"
                   style="max-width:160px; max-height:120px;">
                  <img src="{{ img.image.url }}"
                       alt="attachment"
                       style="width:100%; height:100%; object-fit:cover;">
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      {# คอมเมนต์ #}
      <div class="card card-quiet p-3 mt-3">
        <h2 class="h6 mb-3"><i class="bi bi-chat-dots me-1"></i>คอมเมนต์</h2>

        <div class="vstack gap-3">
          {% for c in comments %}
            <div class="p-3 rounded border bg-white">
              <div class="small text-muted mb-1">
                {{ c.author|display_name }} • {{ c.created_at|localtime|date:"d-m-Y H:i" }}
              </div>
              <div>{{ c.body|linebreaksbr }}</div>
            </div>
          {% empty %}
            <div class="text-muted">ยังไม่มีคอมเมนต์</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Right: quick actions -->
    <div class="col-12 col-lg-3">
      {# เพิ่ม p-4, shadow-sm, h-100 ให้การ์ดดูแน่นขึ้นและสูงตาม content #}
      <div class="card card-quiet p-4 shadow-sm h-100">
        <div class="fw-bold mb-3">Quick Actions</div>
        <div class="vstack gap-2">

          {# เงื่อนไขเดิม: superuser หรือมีสิทธิ์ change_ticket และต้องเป็น assignee (ยกเว้น superuser) และงานยังไม่ปิด #}
          {% if request.user.is_superuser or perms.helpdesk.change_ticket %}
            {% if request.user.is_superuser or request.user == ticket.assignee %}
              {% if ticket.status not in closed_codes %}
                <a class="btn btn-primary w-100 py-3 fs-5"
                   href="{% url 'helpdesk:ticket_update' ticket.id %}">
                  <i class="bi bi-pencil-square me-2"></i>
                  ตรวจสอบงาน
                </a>
              {% endif %}
            {% endif %}
          {% endif %}

          {# ✅ ปุ่มรับงาน #}
          {% if perms.helpdesk.change_ticket %}
            {% if ticket.status not in closed_codes %}
              {% if not ticket.assignee or ticket.assignee == request.user or request.user.is_superuser %}
                <form method="post" action="{% url 'helpdesk:ticket_accept' ticket.id %}">
                  {% csrf_token %}
                  <button class="btn btn-success w-100 py-3 fs-5" type="submit">
                    <i class="bi bi-hand-index-thumb me-2"></i>รับงาน
                  </button>
                </form>
              {% else %}
                <button class="btn btn-outline-secondary w-100 py-3 fs-6" disabled>
                  มีผู้รับงานแล้ว
                </button>
              {% endif %}
            {% endif %}
          {% endif %}

          <a class="btn btn-outline-secondary w-100 py-3 fs-5"
             href="{% url 'helpdesk:ticket_list' %}">
            <i class="bi bi-arrow-left me-2"></i>
            กลับไปหน้ารายการ
          </a>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
