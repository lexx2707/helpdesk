{% extends "helpdesk/base.html" %}
{% load tz %}
{% block title %}{% if ticket %}Edit Ticket{% else %}Create Ticket{% endif %} - Helpdesk{% endblock %}

{% block content %}
<div class="fade-in">
  <div class="d-flex align-items-center justify-content-between">
    <h1 class="h4 mb-0">
      {% if mode == "create" %}
        üìù ‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô
      {% else %}
        üõ† ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
      {% endif %}
    </h1>
    <a href="{% url 'helpdesk:ticket_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </a>
  </div>

  <div class="card card-quiet ticket-form-card p-4 mt-2">

    <form method="post" enctype="multipart/form-data" novalidate class="ticket-form">
      {% csrf_token %}

      {% if form.errors %}
        <div class="alert alert-danger">
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô:
          <pre class="mb-0 small text-monospace">{{ form.errors }}</pre>
        </div>
      {% endif %}

      {% if form.issue_type %}
      <div class="mb-3">
        <label class="form-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</label>

        <select name="issue_type"
                id="id_issue_type"
                class="form-select js-issue-select">
          <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á ‚Äî</option>

          {% regroup form.fields.issue_type.queryset by category.name as issue_groups %}
          {% for g in issue_groups %}
            <optgroup label="{{ g.grouper }}">
              {% for it in g.list %}
                <option value="{{ it.id }}"
                        data-category="{{ it.category.name|default_if_none:'' }}"
                        {% if form.data.issue_type == it.id|stringformat:"s" %}
                          selected
                        {% elif form.instance.issue_type and form.instance.issue_type.id == it.id %}
                          selected
                        {% endif %}>
                  {{ it.name }}
                </option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>

        {% for e in form.issue_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>

      <div class="mb-3">
        <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥):</label>
        <input type="text" id="categoryPreview" class="form-control" value="-" readonly>
      </div>
      {% endif %}

      <div class="mb-3">
        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏´‡∏£‡∏∑‡∏≠ Line ID:</label>
        {{ form.contact }}
        {% for e in form.contact.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>

      <div class="mb-3">
        <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
        {{ form.description }}
        {% for e in form.description.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>

      <div class="mb-3">
        <label class="form-label">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
        <input type="file" name="images" class="form-control" multiple accept="image/*">
        <div class="form-text">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</div>
      </div>

      <div class="row g-3 mt-1">
        {% if form.status %}
        <div class="col-md-6">
          <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
          {{ form.status }}
          {% for e in form.status.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        {% endif %}

        {% if form.assignee %}
        <div class="col-md-6">
          <label class="form-label">Assignee:</label>
          {{ form.assignee }}
          {% for e in form.assignee.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        {% endif %}
      </div>

      {% if ticket and form.comment %}
        <hr class="my-4">
        <h2 class="h6 mb-2"><i class="bi bi-chat-dots me-1"></i>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</h2>
        <div class="mb-2">
          {{ form.comment }}
          {% for e in form.comment.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          <div class="form-text">‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≠‡∏ô‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Äù</div>
        </div>
      {% endif %}

      <div class="d-flex flex-wrap gap-2 mt-3 align-items-center justify-content-between">
        <button type="submit" class="btn btn-lgx btn-save">
          <i class="bi bi-check2-square"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>

        {% if perms.helpdesk.change_ticket and ticket and ticket.status not in closed_codes %}
          <button type="submit"
                  class="btn btn-lgx btn-close-job"
                  formmethod="post"
                  formaction="{% url 'helpdesk:ticket_close' ticket.id %}"
                  onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)?');">
            <i class="bi bi-check2-circle me-1"></i>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
          </button>
        {% endif %}
      </div>

    </form>
  </div>
</div>

<script>
(function(){
  const sel = document.getElementById("id_issue_type");
  const preview = document.getElementById("categoryPreview");
  if (!sel || !preview) return;

  function updatePreview(){
    const opt = sel.options[sel.selectedIndex];
    const cat = opt ? opt.getAttribute("data-category") : "";
    preview.value = cat && cat.trim() ? cat : "-";
  }

  sel.addEventListener("change", updatePreview);
  updatePreview();
})();
</script>
{% endblock %}

{% block extra_js %}
<script>
  $(function () {
    const sel = document.getElementById("id_issue_type");
    const preview = document.getElementById("categoryPreview");
    if (!sel || !preview) return;

    function updatePreview(){
      const opt = sel.options[sel.selectedIndex];
      const cat = opt ? opt.getAttribute("data-category") : "";
      preview.value = cat && cat.trim() ? cat : "-";
    }

    // init select2 ‡∏Å‡πà‡∏≠‡∏ô
    if ($.fn.select2) {
      $('.js-issue-select').select2({
        width: '100%',
        placeholder: '‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á ‚Äî',
        allowClear: true
      });

      // ‚úÖ ‡∏ú‡∏π‡∏Å event ‡∏Ç‡∏≠‡∏á select2
      $('.js-issue-select').on('select2:select select2:clear', function () {
        updatePreview();
      });
    } else {
      console.warn("Select2 not loaded");
    }

    // ‚úÖ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ select ‡∏õ‡∏Å‡∏ï‡∏¥
    sel.addEventListener("change", updatePreview);

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    updatePreview();
  });
</script>
{% endblock %}

