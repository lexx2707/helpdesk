{% extends "helpdesk/base.html" %}
{% load users %}
{% block title %}Users - Helpdesk{% endblock %}

{% block content %}
<div class="fade-in">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0"><i class="bi bi-people me-2"></i>ผู้ใช้ทั้งหมด</h1>
    <div class="d-flex gap-2">
      <form method="get" class="d-flex gap-2">
        <input class="form-control" name="q" value="{{ q }}" placeholder="ค้นหาชื่อ/อีเมล/username…">
        <button class="btn btn-outline-secondary">
          <i class="bi bi-search"></i>
        </button>
      </form>
      {% if perms.auth.add_user %}
      <a href="{% url 'helpdesk:user_create' %}" class="btn btn-primary">
        <i class="bi bi-person-plus me-1"></i> เพิ่มผู้ใช้
      </a>
      {% endif %}
    </div>
  </div>

  <div class="card card-quiet">
    <div class="table-responsive">
      <table id="usersTable" class="table align-middle mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th>ชื่อ</th>
            <th>อีเมล</th>
            <th>สิทธิ์</th>
            <th>สถานะ</th>
            <th class="text-end">จัดการ</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>
            {{ u|display_name }}
              <span class="text-muted">@{{ u.username }}</span>
            </td>
            <td>{{ u.email|default:"-" }}</td>
            <td>
              {% if u.is_superuser %}
                <span class="badge text-bg-dark">superuser</span>
              {% elif u.is_staff %}
                <span class="badge text-bg-secondary">staff</span>
              {% else %}
                <span class="badge text-bg-light">user</span>
              {% endif %}
            </td>
            <td>
              {% if u.is_active %}
                <span class="badge text-bg-success">active</span>
              {% else %}
                <span class="badge text-bg-danger">inactive</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if perms.auth.change_user %}
                <a class="btn btn-sm btn-outline-primary"
                   href="{% url 'helpdesk:user_edit' u.id %}">
                  <i class="bi bi-pencil-square fs-5"></i>
                </a>
              {% endif %}
              {% if perms.auth.delete_user and not u.is_superuser %}
                <form method="post"
                      action="{% url 'helpdesk:user_deactivate' u.id %}"
                      class="d-inline">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('ปิดใช้งานผู้ใช้คนนี้?');"
                        title="ปิดใช้งานผู้ใช้">
                  <i class="bi bi-person-x fs-5"></i>
                  </button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              ยังไม่มีผู้ใช้
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // ปิด error popup ของ DataTables
  $.fn.dataTable.ext.errMode = 'none';

  document.addEventListener('DOMContentLoaded', function () {
    if (window.jQuery && $.fn.DataTable) {
      $('#usersTable').DataTable({
        ordering: true,          // ให้คลิกหัวคอลัมน์เรียงได้
        order: [[0, 'asc']],     // เริ่มต้นเรียงตามลำดับ ID
        paging: false,           // ไม่ต้องแบ่งหน้า
        searching: false,        // ใช้ช่องค้นหาด้านบนแทน
        info: false              // ไม่ต้องแสดง "Showing x of y"
      });
    }
  });
</script>
{% endblock %}
{% endblock %}
